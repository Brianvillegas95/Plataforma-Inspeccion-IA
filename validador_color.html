<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Color con JSON - Grupo Azor</title>
    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="deltae.js"></script> 
</head>
<body class="color-validator-body">
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <img src="imagenes/Logo azor.png" alt="Logo Grupo Azor" class="logo">
                <h1>Inspección de Calidad <span class="ia-badge">IA</span></h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li class="dropdown">
                        <a href="index.html" class="dropdown-toggle">Inicio</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle active" data-area="Moldeo">Moldeo<i class="fas fa-angle-down nav-arrow"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="validador_color.html">ColorChecK AI</a></li>
                            <li><a href="#">Proceso B (Próximamente)</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </header>

        <main class="main-content">
            <section class="tool-section color-validator-tool">
                <div class="section-header">
                    <i class="fas fa-palette feature-icon"></i>
                    <h2>Estación Digital de Validación de Color</h2>
                    <p>Capture una imagen y dibuje un recuadro sobre el área de color a validar.</p>
                </div>

                <div class="color-validator-grid">
                    <div class="color-capture-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-camera"></i> 1. Captura de Imagen</h3>
                        <div id="color-webcam-container" class="webcam-view">
                            <video id="color-video-feed" playsinline autoplay muted></video>
                            <p id="webcam-loading-prompt">Activando cámara...</p>
                        </div>
                        <canvas id="color-capture-canvas" style="display:none;"></canvas> 
                        
                        <div class="capture-actions" style="display: flex; gap: 10px; margin-top: 10px; margin-bottom:10px;">
                            <button id="capture-color-btn" class="button primary-action" style="flex: 1;">
                                <i class="fas fa-camera-retro"></i> Capturar Imagen
                            </button>
                            <label for="upload-image-btn-input" class="button secondary-action" style="flex: 1; cursor: pointer;">
                                <i class="fas fa-upload"></i> Subir Imagen
                            </label>
                            <input type="file" id="upload-image-btn-input" accept="image/*" style="display: none;">
                        </div>

                        <div class="color-picker-instructions">
                            <p id="instruction-text">Tras capturar o subir una imagen, dibuje un recuadro para seleccionar el área de color.</p>
                        </div>
                    </div>

                    <div class="color-analysis-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-crop-alt"></i> 2. Área de Muestra y Estándar</h3>
                        <div class="captured-image-area">
                            <canvas id="display-captured-image-canvas" class="captured-image-canvas"></canvas> 
                            <p id="capture-prompt">Active la cámara y capture, o suba una imagen para analizar.</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="standard-color-select">Seleccione Color Estándar Azor:</label>
                            <select id="standard-color-select" name="standard-color-select">
                                <option value="">Cargando estándares...</option>
                            </select>
                        </div>
                        <button id="compare-colors-btn" class="button secondary-action full-width-button" disabled>
                            <i class="fas fa-exchange-alt"></i> Comparar Colores
                        </button>
                    </div>

                    <div class="color-results-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-tachometer-alt"></i> 3. Resultados</h3>
                        <div class="color-comparison-display">
                            <div class="color-box-container">
                                <p>Color de Muestra (Promedio):</p>
                                <div id="captured-color-display" class="color-display-box"></div>
                                <span id="captured-color-values" class="color-value-text">-</span>
                            </div>
                            <div class="color-box-container">
                                <p>Color Estándar:</p>
                                <div id="standard-color-display" class="color-display-box"></div>
                                <span id="standard-color-values" class="color-value-text">-</span>
                            </div>
                        </div>
                        <div class="delta-e-result">
                            <h4>Diferencia de Color (ΔE*<sub_00</sub>):</h4>
                            <p id="delta-e-value" class="delta-e-value-text">-</p>
                            <div class="tolerance-bar-container">
                                <div id="tolerance-bar" class="tolerance-bar-fill"></div>
                            </div>
                            <p id="tolerance-status" class="tolerance-status-text">-</p>
                        </div>
                         <p id="color-result-note" class="note" style="margin-top:10px;"></p>
                         
                         <div id="delta-breakdown-section" style="margin-top: 15px; display: none;">
                            <h5>Desglose de Diferencias:</h5>
                            <p class="delta-component-text" id="delta-L-value">ΔL*: -</p>
                            <p class="delta-component-text" id="delta-a-value">ΔA*: -</p>
                            <p class="delta-component-text" id="delta-b-value">ΔB*: -</p>
                         </div>
                         <div id="summary-section" style="margin-top: 15px; display: none;">
                            <h5>Resumen para Copiar:</h5>
                            <textarea id="validation-summary" rows="5" style="width: 100%; font-size: 0.8em; padding: 5px; border-radius: var(--border-radius); border: 1px solid var(--border-color);" readonly></textarea>
                            <button id="copy-summary-btn" class="button" style="font-size: 0.8em; padding: 5px 10px; margin-top: 5px;">Copiar Resumen</button>
                         </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            &copy; <span id="currentYearColorValidator"></span> Grupo Azor México. Todos los derechos reservados.
        </footer>
    </div>

    <script type="text/javascript">
        if(document.getElementById('currentYearColorValidator')) {
            document.getElementById('currentYearColorValidator').textContent = new Date().getFullYear();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: Inicio DOMContentLoaded.");
            console.log("DEBUG: typeof window.chroma:", typeof window.chroma, "(debería ser 'function')");
            console.log("DEBUG: typeof window.DeltaE:", typeof window.DeltaE, "(debería ser 'object' si deltae.js local se carga bien)");
            
            const UMBRAL_EXCELENTE = 2.0;
            const UMBRAL_ACEPTABLE = 5.0;
            const MAX_DELTA_E_FOR_BAR = 10.0;

            const videoElement = document.getElementById('color-video-feed');
            const webcamLoadingPrompt = document.getElementById('webcam-loading-prompt');
            const captureButton = document.getElementById('capture-color-btn');
            const uploadImageInput = document.getElementById('upload-image-btn-input'); 
            
            const displayCanvas = document.getElementById('display-captured-image-canvas');
            const displayCtx = displayCanvas ? displayCanvas.getContext('2d', { willReadFrequently: true }) : null;
            const captureCanvas = document.getElementById('color-capture-canvas'); 
            const captureCtx = captureCanvas ? captureCanvas.getContext('2d', { willReadFrequently: true }) : null;
            
            const capturePrompt = document.getElementById('capture-prompt');
            const instructionTextEl = document.getElementById('instruction-text');
            const compareButton = document.getElementById('compare-colors-btn');
            const standardColorSelect = document.getElementById('standard-color-select');
            
            const capturedColorDisplay = document.getElementById('captured-color-display');
            const capturedColorValuesEl = document.getElementById('captured-color-values');
            const standardColorDisplay = document.getElementById('standard-color-display');
            const standardColorValuesEl = document.getElementById('standard-color-values');
            const deltaEValueEl = document.getElementById('delta-e-value');
            const toleranceBar = document.getElementById('tolerance-bar');
            const toleranceStatusEl = document.getElementById('tolerance-status'); 
            const colorResultNoteEl = document.getElementById('color-result-note');

            const deltaBreakdownSection = document.getElementById('delta-breakdown-section');
            const deltaLValueEl = document.getElementById('delta-L-value');
            const deltaAValueEl = document.getElementById('delta-a-value');
            const deltaBValueEl = document.getElementById('delta-b-value');
            const summarySection = document.getElementById('summary-section');
            const validationSummaryEl = document.getElementById('validation-summary');
            const copySummaryBtn = document.getElementById('copy-summary-btn');

            let stream = null;
            let pickedColorRGB = null; 
            let currentStandardColorData = null;
            let imageIsCaptured = false; 
            let isDrawingSelection = false;
            let selectionRect = { startX: 0, startY: 0, currentX: 0, currentY: 0, width: 0, height: 0 };

            // Variable para almacenar los colores cargados del JSON
            let coloresEstandarCargados = [];

            function rgbToHex(r, g, b) {
                const toHex = c => (c < 16 ? '0' : '') + c.toString(16);
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
            }

            // Función para cargar colores desde JSON
            async function cargarColoresDesdeJSON() {
                // Ruta relativa al archivo JSON. Asume que 'Archivos_JSON' está al mismo nivel que tu HTML, o ajusta la ruta.
                const jsonPath = 'Archivos_JSON/colores_estandar.json'; 
                try {
                    console.log(`DEBUG: Intentando cargar JSON desde: ${jsonPath}`);
                    const response = await fetch(jsonPath);
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status} al cargar ${jsonPath}: ${response.statusText}`);
                    }
                    coloresEstandarCargados = await response.json();
                    console.log("DEBUG: Colores estándar cargados desde JSON:", coloresEstandarCargados);
                    if (!Array.isArray(coloresEstandarCargados)) {
                        throw new Error("El archivo JSON no contiene un array de colores.");
                    }
                    populateStandardColors(); // Poblar el select DESPUÉS de cargar los colores
                } catch (error) {
                    console.error("Error fatal al cargar o procesar los colores estándar desde JSON:", error);
                    if(standardColorSelect) standardColorSelect.innerHTML = '<option value="">Error al cargar estándares</option>';
                    if(capturePrompt) capturePrompt.textContent = "Error al cargar estándares de color. Verifique consola (F12).";
                    alert(`No se pudieron cargar los colores estándar desde '${jsonPath}'. Verifique la ruta y el contenido del archivo, y las restricciones de seguridad del navegador para archivos locales (CORS). Se recomienda usar un servidor local para desarrollo.`);
                }
            }

            function populateStandardColors() {
                if (!standardColorSelect) { 
                    console.error("DEBUG: Select para colores estándar no encontrado.");
                    return; 
                }
                if (!coloresEstandarCargados || coloresEstandarCargados.length === 0) {
                    standardColorSelect.innerHTML = '<option value="">No hay estándares disponibles</option>';
                    console.warn("DEBUG: No hay colores estándar cargados para poblar el select.");
                    return;
                }
                
                standardColorSelect.innerHTML = '<option value="">-- Elija un estándar --</option>';
                coloresEstandarCargados.forEach(color => {
                    if (color && color.id && color.nombre) { // Verificación básica de datos
                        const option = document.createElement('option');
                        option.value = color.id; 
                        option.textContent = color.nombre;
                        standardColorSelect.appendChild(option);
                    } else {
                        console.warn("DEBUG: Se encontró un color inválido o incompleto en los datos JSON:", color);
                    }
                });
            }
            
            async function startWebcam() {
                if (!videoElement || !captureCanvas || !displayCanvas || !webcamLoadingPrompt || !capturePrompt || !displayCtx || !captureCtx) {
                    if (webcamLoadingPrompt) webcamLoadingPrompt.textContent = "Error: Elementos de UI no encontrados.";
                    return;
                }
                webcamLoadingPrompt.style.display = 'block';
                videoElement.style.display = 'block'; 
                capturePrompt.textContent = "Activando cámara...";
                capturePrompt.style.display = 'block'; 
                if (displayCtx) displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } } });
                    videoElement.srcObject = stream;
                    await new Promise((resolve, reject) => { /* ... código de promesa de dimensiones ... */ 
                        let resolved = false; let loadAttempts = 0; const maxLoadAttempts = 5; 
                        function checkVideoDimensions() {
                            if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                                if (!resolved) {
                                    captureCanvas.width = videoElement.videoWidth; captureCanvas.height = videoElement.videoHeight;
                                    const webcamContainerEl = document.getElementById('color-webcam-container');
                                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                                    let dCanvasWidth = (webcamContainerEl && webcamContainerEl.clientWidth > 0) ? webcamContainerEl.clientWidth - 2 : 300; 
                                    let dCanvasHeight = dCanvasWidth / aspectRatio;
                                    if (dCanvasHeight > 280) { dCanvasHeight = 280; dCanvasWidth = dCanvasHeight * aspectRatio; }
                                    displayCanvas.width = dCanvasWidth; displayCanvas.height = dCanvasHeight;
                                    resolved = true; resolve();
                                }
                            } else {
                                loadAttempts++;
                                if (loadAttempts < maxLoadAttempts && !resolved) { setTimeout(checkVideoDimensions, 500); } 
                                else if (!resolved) { reject(new Error("Dimensiones del video siguen siendo 0.")); }
                            }
                        }
                        videoElement.onloadedmetadata = checkVideoDimensions; videoElement.oncanplay = checkVideoDimensions; 
                        videoElement.onerror = (e) => { if (!resolved) reject(new Error("Error al cargar metadata/video: " + e)); };
                        setTimeout(() => { if (!resolved) reject(new Error("Timeout esperando metadata/video.")); }, 4000); 
                    });
                    if (webcamLoadingPrompt) webcamLoadingPrompt.style.display = 'none';
                    if (capturePrompt) capturePrompt.textContent = "Cámara activa. Enfoque y capture la imagen.";
                    imageIsCaptured = false; pickedColorRGB = null; 
                    checkEnableCompareButton();
                } catch (err) {
                    console.error("Validador Color: Error al acceder/configurar webcam: ", err);
                    if (webcamLoadingPrompt) webcamLoadingPrompt.textContent = "No se pudo acceder a la cámara. Verifique permisos, o suba una imagen.";
                    if (capturePrompt) capturePrompt.textContent = "Error de cámara. Pruebe subiendo una imagen.";
                }
            }
            
            function resetUIForNewCapture() {
                if (capturePrompt) capturePrompt.style.display = 'none'; 
                imageIsCaptured = true; pickedColorRGB = null; 
                if (compareButton) {
                    compareButton.disabled = true;
                    compareButton.innerHTML = '<i class="fas fa-exchange-alt"></i> Comparar Colores';
                }
                if(capturedColorDisplay) capturedColorDisplay.style.backgroundColor = 'transparent';
                if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Dibuje un área en la imagen';
                if(deltaEValueEl) deltaEValueEl.textContent = '-';
                if(toleranceStatusEl) { toleranceStatusEl.textContent = '-'; toleranceStatusEl.className = 'tolerance-status-text'; }
                if(toleranceBar) { toleranceBar.style.width = '0%'; toleranceBar.className = 'tolerance-bar-fill'; }
                if(instructionTextEl) instructionTextEl.textContent = "Dibuje un recuadro en la imagen para seleccionar el área de color.";
                if(colorResultNoteEl) colorResultNoteEl.textContent = '';
                if (deltaBreakdownSection) deltaBreakdownSection.style.display = 'none';
                if (summarySection) summarySection.style.display = 'none';
                if (validationSummaryEl) validationSummaryEl.value = '';
                checkEnableCompareButton();
            }

            function processImageAndDisplay(sourceElementOrCanvas, isUploadedImage = false) {
                 if (isUploadedImage) { 
                    captureCanvas.width = sourceElementOrCanvas.naturalWidth;
                    captureCanvas.height = sourceElementOrCanvas.naturalHeight;
                    captureCtx.drawImage(sourceElementOrCanvas, 0, 0, captureCanvas.width, captureCanvas.height);
                } else { 
                    if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                        captureCanvas.width = videoElement.videoWidth;
                        captureCanvas.height = videoElement.videoHeight;
                    } else {
                        console.warn("Dimensiones del video no disponibles, usando fallback para captura.");
                        captureCanvas.width = 640; captureCanvas.height = 480; 
                    }
                    captureCtx.drawImage(videoElement, 0, 0, captureCanvas.width, captureCanvas.height);
                }
                const aspectRatio = captureCanvas.width / captureCanvas.height;
                let dCanvasWidth = displayCanvas.parentElement.clientWidth > 0 ? displayCanvas.parentElement.clientWidth - 2 : 300;
                let dCanvasHeight = dCanvasWidth / aspectRatio;
                if (dCanvasHeight > 280) { dCanvasHeight = 280; dCanvasWidth = dCanvasHeight * aspectRatio; }
                displayCanvas.width = dCanvasWidth; displayCanvas.height = dCanvasHeight;
                if (displayCtx) {
                    displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height); 
                    displayCtx.drawImage(captureCanvas, 0, 0, displayCanvas.width, displayCanvas.height);
                }
                resetUIForNewCapture();
            }

            if (captureButton) {
                captureButton.addEventListener('click', () => {
                    if (!stream || !videoElement.srcObject || videoElement.paused || videoElement.ended) {
                         if (capturePrompt) capturePrompt.textContent = "La cámara no está activa. Intente recargar o suba una imagen.";
                        return;
                    }
                    processImageAndDisplay(videoElement, false);
                });
            }

            if (uploadImageInput) {
                 uploadImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                if (stream) {
                                    stream.getTracks().forEach(track => track.stop());
                                    stream = null;
                                    videoElement.srcObject = null;
                                    videoElement.style.display = 'none'; 
                                    if (webcamLoadingPrompt) webcamLoadingPrompt.style.display = 'none';
                                }
                                if (capturePrompt) capturePrompt.textContent = "Imagen cargada. Seleccione el área.";
                                processImageAndDisplay(img, true);
                            }
                            img.onerror = () => {
                                if (capturePrompt) capturePrompt.textContent = "Error al cargar la imagen seleccionada.";
                                console.error("Error al cargar la imagen del archivo.");
                            }
                            img.src = e.target.result;
                        }
                        reader.onerror = () => {
                            if (capturePrompt) capturePrompt.textContent = "Error al leer el archivo de imagen.";
                            console.error("Error al leer el archivo.");
                        }
                        reader.readAsDataURL(file);
                    }
                    event.target.value = null;
                });
            }

            function checkEnableCompareButton() {
                if (compareButton) {
                    const standardSelected = standardColorSelect && standardColorSelect.value !== "" && currentStandardColorData;
                    compareButton.disabled = !(pickedColorRGB && standardSelected);
                }
            }

            if (displayCanvas && displayCtx && captureCtx) {
                // ... (Listeners mousedown, mousemove, mouseup sin cambios mayores)
                displayCanvas.addEventListener('mousedown', (event) => { /* ... */ });
                displayCanvas.addEventListener('mousemove', (event) => { /* ... */ });
                displayCanvas.addEventListener('mouseup', () => { /* ... (el mouseup es largo, se asume el mismo que la última vez) ... */
                    if (!imageIsCaptured || !isDrawingSelection) { isDrawingSelection = false; return; }
                    isDrawingSelection = false;
                    let finalRectX = Math.min(selectionRect.startX, selectionRect.currentX);
                    let finalRectY = Math.min(selectionRect.startY, selectionRect.currentY);
                    let finalRectWidth = Math.abs(selectionRect.width);
                    let finalRectHeight = Math.abs(selectionRect.height);
                    if (!(displayCtx && captureCanvas && captureCanvas.width > 0 && captureCanvas.height > 0 && captureCtx)) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Imagen base no disp.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
                    displayCtx.drawImage(captureCanvas, 0, 0, displayCanvas.width, displayCanvas.height);
                    if (finalRectWidth < 1 || finalRectHeight < 1) { 
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Área muy pequeña.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    if (displayCanvas.width === 0 || displayCanvas.height === 0) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Display inválido.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    const scaleX = captureCanvas.width / displayCanvas.width; const scaleY = captureCanvas.height / displayCanvas.height;
                    let originalX = Math.floor(finalRectX * scaleX); let originalY = Math.floor(finalRectY * scaleY);
                    let originalWidth = Math.floor(finalRectWidth * scaleX); let originalHeight = Math.floor(finalRectHeight * scaleY);
                    originalX = Math.max(0, Math.min(originalX, captureCanvas.width - 1));
                    originalY = Math.max(0, Math.min(originalY, captureCanvas.height - 1));
                    originalWidth = Math.max(1, Math.min(originalWidth, captureCanvas.width - originalX)); 
                    originalHeight = Math.max(1, Math.min(originalHeight, captureCanvas.height - originalY));
                    if (originalWidth <= 0 || originalHeight <= 0) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Área cálculo inválida.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    try {
                        const imageData = captureCtx.getImageData(originalX, originalY, originalWidth, originalHeight);
                        const data = imageData.data; let sumR = 0, sumG = 0, sumB = 0; let pixelCount = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            sumR += data[i]; sumG += data[i+1]; sumB += data[i+2]; pixelCount++;
                        }
                        if (pixelCount > 0) {
                            pickedColorRGB = { r: Math.round(sumR / pixelCount), g: Math.round(sumG / pixelCount), b: Math.round(sumB / pixelCount) };
                            const hexPicked = rgbToHex(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b);
                            let labCapturedText = 'N/A'; let labConversionOk = false;
                            if (typeof window.chroma !== 'undefined') { 
                                try {
                                    const labArr = window.chroma(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b).lab();
                                    labCapturedText = `${labArr[0].toFixed(1)}, ${labArr[1].toFixed(1)}, ${labArr[2].toFixed(1)}`;
                                    labConversionOk = true;
                                } catch (chromaError) {
                                    console.error("Error al usar chroma-js para convertir RGB a LAB:", chromaError);
                                    if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: Error chroma.js`;
                                }
                            } else {
                                console.warn("Librería 'chroma-js' (window.chroma) NO está definida.");
                                if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: Error lib. conversión`;
                            }
                            if (capturedColorDisplay) capturedColorDisplay.style.backgroundColor = hexPicked;
                            if (labConversionOk) { 
                                if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: ${labCapturedText}`;
                            }
                            if (instructionTextEl) instructionTextEl.textContent = "Área seleccionada. Elija un estándar.";
                            displayCtx.strokeStyle = 'rgba(40, 167, 69, 0.9)'; displayCtx.lineWidth = 2;
                            displayCtx.strokeRect(finalRectX, finalRectY, finalRectWidth, finalRectHeight); 
                        } else {
                             if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'No se pudo promediar (0px).';
                             pickedColorRGB = null;
                        }
                    } catch (e) {
                        console.error("Error al procesar datos del área (catch):", e); 
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error procesar área.';
                        pickedColorRGB = null;
                    }
                    checkEnableCompareButton();
                 });
            } else {
                console.error("Validador Color: Canvas de dibujo no encontrado/inicializado.");
            }
            
            if (standardColorSelect) {
                standardColorSelect.addEventListener('change', () => {
                    const selectedId = standardColorSelect.value; // 'id' del JSON
                    if (selectedId) {
                        currentStandardColorData = coloresEstandarCargados.find(color => color.id === selectedId);
                        if(currentStandardColorData && currentStandardColorData.lab) { // Asegurar que .lab exista
                            if(standardColorDisplay) standardColorDisplay.style.backgroundColor = currentStandardColorData.hex;
                            if(standardColorValuesEl) {
                                // Asumimos que el JSON tiene L, A, B para lab
                                standardColorValuesEl.textContent = `HEX: ${currentStandardColorData.hex.toUpperCase()} | LAB: ${currentStandardColorData.lab.L.toFixed(1)}, ${currentStandardColorData.lab.A.toFixed(1)}, ${currentStandardColorData.lab.B.toFixed(1)}`;
                            }
                        } else {
                           currentStandardColorData = null; 
                           console.warn("Color estándar seleccionado no encontrado o no tiene datos LAB:", selectedId);
                        }
                    } else {
                        currentStandardColorData = null;
                        if(standardColorDisplay) standardColorDisplay.style.backgroundColor = 'transparent';
                        if(standardColorValuesEl) standardColorValuesEl.textContent = '-';
                    }
                    checkEnableCompareButton(); 
                });
            }

            if (compareButton) {
                compareButton.addEventListener('click', () => {
                    const originalButtonText = compareButton.innerHTML;
                    compareButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Comparando...';
                    compareButton.disabled = true;

                    setTimeout(() => {
                        if (!pickedColorRGB || !currentStandardColorData) {
                            if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Faltan datos.';
                            if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Faltan datos'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                            compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }
                        
                        let labSampleFromChroma; let conversionOkForComparison = false;
                        if (typeof window.chroma !== 'function') {
                            console.error("Librería 'chroma-js' NO disponible.");
                            if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Lib. Conversión';
                            if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Lib. Chroma'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                            compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }
                        try {
                            const labChromaArray = window.chroma(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b).lab();
                            labSampleFromChroma = { L: parseFloat(labChromaArray[0]), a: parseFloat(labChromaArray[1]), b: parseFloat(labChromaArray[2]) };
                            if (isNaN(labSampleFromChroma.L) || isNaN(labSampleFromChroma.a) || isNaN(labSampleFromChroma.b)) {
                                console.error("Chroma.js: conversión LAB resultó en NaN.", labChromaArray);
                                throw new Error("Conversión LAB NaN");
                            }
                            conversionOkForComparison = true;
                        } catch (chromaError) {
                             console.error("Error con chroma-js:", chromaError);
                             if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Conv. LAB';
                             if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Conversión'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                             compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }

                        const labStandardData = currentStandardColorData.lab; 
                         if (!labStandardData || typeof labStandardData.L !== 'number' || typeof labStandardData.A !== 'number' || typeof labStandardData.B !== 'number') {
                             console.error("Datos LAB del estándar inválidos:", labStandardData);
                             if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Estándar LAB';
                             if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Estándar'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                             compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }

                        const labForDeltaESample = { L: labSampleFromChroma.L, A: labSampleFromChroma.a, B: labSampleFromChroma.b };
                        const labForDeltaEStandard = { L: labStandardData.L, A: labStandardData.A, B: labStandardData.B };

                        if (typeof window.DeltaE === 'undefined' || (window.DeltaE && typeof window.DeltaE.getDeltaE00 !== 'function')) {
                            console.error("Librería 'DeltaE' NO disponible.");
                            if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Lib. Delta E';
                            if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Librería ΔE'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                            compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }
                        
                        let deltaE;
                        try {
                            deltaE = window.DeltaE.getDeltaE00(labForDeltaESample, labForDeltaEStandard);
                        } catch (deltaError) {
                            console.error("Error al calcular Delta E:", deltaError);
                            if (deltaEValueEl) deltaEValueEl.textContent = 'Error: Cálculo ΔE';
                            if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Cálculo ΔE'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                            compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return;
                        }
                        
                        if (isNaN(deltaE)) {
                            console.error("DeltaE resultó en NaN. Inputs:", labForDeltaESample, labForDeltaEStandard);
                            if (deltaEValueEl) deltaEValueEl.textContent = 'NaN (Err. Cálculo)';
                            if (toleranceStatusEl) { toleranceStatusEl.textContent = 'Error Cálculo (NaN)'; toleranceStatusEl.className = 'tolerance-status-text status-danger'; }
                            if (toleranceBar) { toleranceBar.style.width = '0%'; toleranceBar.className = 'tolerance-bar-fill status-danger'; }
                            compareButton.innerHTML = originalButtonText; checkEnableCompareButton(); return; 
                        }

                        if (deltaEValueEl) deltaEValueEl.textContent = deltaE.toFixed(2);
                        
                        deltaLValueEl.textContent = `ΔL*: ${(labForDeltaESample.L - labForDeltaEStandard.L).toFixed(2)}`;
                        deltaAValueEl.textContent = `ΔA*: ${(labForDeltaESample.A - labForDeltaEStandard.A).toFixed(2)}`;
                        deltaBValueEl.textContent = `ΔB*: ${(labForDeltaESample.B - labForDeltaEStandard.B).toFixed(2)}`;
                        if (deltaBreakdownSection) deltaBreakdownSection.style.display = 'block';

                        const summaryText = `Validación de Color:\n---------------------------------\nMuestra:\n  HEX: ${rgbToHex(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b)}\n  LAB: L*=${labSampleFromChroma.L.toFixed(1)}, a*=${labSampleFromChroma.a.toFixed(1)}, b*=${labSampleFromChroma.b.toFixed(1)}\nEstándar (${currentStandardColorData.nombre}):\n  HEX: ${currentStandardColorData.hex}\n  LAB: L*=${labForDeltaEStandard.L.toFixed(1)}, A*=${labForDeltaEStandard.A.toFixed(1)}, B*=${labForDeltaEStandard.B.toFixed(1)}\n---------------------------------\nResultado:\n  ΔE*₀₀: ${deltaE.toFixed(2)}`;
                        if (validationSummaryEl) validationSummaryEl.value = summaryText;
                        if (summarySection) summarySection.style.display = 'block';

                        let statusText = ''; let barClass = 'tolerance-bar-fill'; let statusClass = ''; let barWidthPercentage = 0;
                        if (deltaE <= UMBRAL_EXCELENTE) { statusText = 'Aprobado (Excelente)'; statusClass = 'status-ok'; barWidthPercentage = (deltaE / UMBRAL_EXCELENTE) * (100 / 3);
                        } else if (deltaE <= UMBRAL_ACEPTABLE) { statusText = 'Aprobado (Aceptable)'; statusClass = 'status-warning'; barWidthPercentage = (100 / 3) + ((deltaE - UMBRAL_EXCELENTE) / (UMBRAL_ACEPTABLE - UMBRAL_EXCELENTE)) * (100 / 3);
                        } else { statusText = 'Rechazado (Fuera de Tolerancia)'; statusClass = 'status-danger'; if (deltaE <= MAX_DELTA_E_FOR_BAR) { barWidthPercentage = (200 / 3) + ((deltaE - UMBRAL_ACEPTABLE) / (MAX_DELTA_E_FOR_BAR - UMBRAL_ACEPTABLE)) * (100 / 3); } else { barWidthPercentage = 100; } }
                        barWidthPercentage = Math.min(100, Math.max(0, barWidthPercentage)); 
                        if (toleranceStatusEl) { toleranceStatusEl.textContent = statusText; toleranceStatusEl.className = 'tolerance-status-text'; toleranceStatusEl.classList.add(statusClass); }
                        if (toleranceBar) { toleranceBar.style.width = `${barWidthPercentage}%`; toleranceBar.className = `tolerance-bar-fill ${statusClass}`; }
                        if (colorResultNoteEl) { /* ... código de nota ... */ 
                            let note = `Un valor ΔE*₀₀ de ${deltaE.toFixed(2)} indica la diferencia perceptual. `;
                            if (deltaE <= 1.0) note += "Generalmente imperceptible."; else if (deltaE <= 2.0) note += "Diferencia muy pequeña.";
                            else if (deltaE <= 5.0) note += "Diferencia perceptible."; else if (deltaE <= 10.0) note += "Claramente perceptible.";
                            else note += "Diferencia muy grande.";
                            colorResultNoteEl.textContent = note;
                        }
                        compareButton.innerHTML = originalButtonText;
                        checkEnableCompareButton();
                    }, 10); 
                });
            }

            if (copySummaryBtn) { /* ... listener de copySummaryBtn ... */ 
                copySummaryBtn.addEventListener('click', () => {
                    if (validationSummaryEl && validationSummaryEl.value) {
                        validationSummaryEl.select();
                        try {
                            navigator.clipboard.writeText(validationSummaryEl.value).then(() => {
                                alert('Resumen copiado al portapapeles.');
                            }).catch(err => {
                                console.warn('Fallo al copiar con navigator.clipboard, intentando execCommand:', err);
                                document.execCommand('copy'); // Fallback
                                alert('Resumen copiado (fallback).');
                            });
                        } catch (err) {
                            alert('Error al copiar. Por favor, copie manualmente.');
                            console.error('Error al copiar con execCommand:', err);
                        }
                        if (window.getSelection) { window.getSelection().removeAllRanges();
                        } else if (document.selection) { document.selection.empty(); }
                    }
                });
            }
            
            async function inicializarValidador() {
                await cargarColoresDesdeJSON(); 
                // populateStandardColors(); // Ya se llama dentro de cargarColoresDesdeJSON
                startWebcam(); 
            }
            inicializarValidador();
        });
    </script>
</body>
</html>