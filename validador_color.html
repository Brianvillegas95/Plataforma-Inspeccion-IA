<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Color (Selección Corregida) - Grupo Azor</title>
    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="deltae.js"></script> 
</head>
<body class="color-validator-body">
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <img src="imagenes/Logo azor.png" alt="Logo Grupo Azor" class="logo">
                <h1>Inspección de Calidad <span class="ia-badge">IA</span></h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li class="dropdown">
                        <a href="index.html" class="dropdown-toggle">Inicio</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle active" data-area="Moldeo">Moldeo<i class="fas fa-angle-down nav-arrow"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="validador_color.html">ColorChecK AI</a></li>
                            <li><a href="#">Proceso B (Próximamente)</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </header>

        <main class="main-content">
            <section class="tool-section color-validator-tool">
                <div class="section-header">
                    <i class="fas fa-palette feature-icon"></i>
                    <h2>Estación Digital de Validación de Color</h2>
                    <p>Capture una imagen y dibuje un recuadro sobre el área de color a validar.</p>
                </div>

                <div class="color-validator-grid">
                    <div class="color-capture-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-camera"></i> 1. Captura de Imagen</h3>
                        <div id="color-webcam-container" class="webcam-view">
                            <video id="color-video-feed" playsinline autoplay muted></video>
                            <p id="webcam-loading-prompt">Activando cámara...</p>
                        </div>
                        <canvas id="color-capture-canvas" style="display:none;"></canvas> 
                        
                        <div class="capture-actions" style="display: flex; gap: 10px; margin-top: 10px; margin-bottom:10px;">
                            <button id="capture-color-btn" class="button primary-action" style="flex: 1;">
                                <i class="fas fa-camera-retro"></i> Capturar Imagen
                            </button>
                            <label for="upload-image-btn-input" class="button secondary-action" style="flex: 1; cursor: pointer;">
                                <i class="fas fa-upload"></i> Subir Imagen
                            </label>
                            <input type="file" id="upload-image-btn-input" accept="image/*" style="display: none;">
                        </div>

                        <div class="color-picker-instructions">
                            <p id="instruction-text">Tras capturar o subir una imagen, dibuje un recuadro para seleccionar el área de color.</p>
                        </div>
                    </div>

                    <div class="color-analysis-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-crop-alt"></i> 2. Área de Muestra y Estándar</h3>
                        <div class="captured-image-area">
                            <canvas id="display-captured-image-canvas" class="captured-image-canvas"></canvas> 
                            <p id="capture-prompt">Active la cámara y capture, o suba una imagen para analizar.</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="standard-color-select">Seleccione Color Estándar Azor:</label>
                            <select id="standard-color-select" name="standard-color-select">
                                <option value="">Cargando estándares...</option>
                            </select>
                        </div>
                        <button id="compare-colors-btn" class="button secondary-action full-width-button" disabled>
                            <i class="fas fa-exchange-alt"></i> Comparar Colores
                        </button>
                    </div>

                    <div class="color-results-panel">
                        <h3 class="panel-title-sub"><i class="fas fa-tachometer-alt"></i> 3. Resultados</h3>
                        <div class="color-comparison-display">
                            <div class="color-box-container">
                                <p>Color de Muestra (Promedio):</p>
                                <div id="captured-color-display" class="color-display-box"></div>
                                <span id="captured-color-values" class="color-value-text">-</span>
                            </div>
                            <div class="color-box-container">
                                <p>Color Estándar:</p>
                                <div id="standard-color-display" class="color-display-box"></div>
                                <span id="standard-color-values" class="color-value-text">-</span>
                            </div>
                        </div>
                        <div class="delta-e-result">
                            <h4>Diferencia de Color (ΔE*<sub_00</sub>):</h4>
                            <p id="delta-e-value" class="delta-e-value-text">-</p>
                            <div class="tolerance-bar-container">
                                <div id="tolerance-bar" class="tolerance-bar-fill"></div>
                            </div>
                            <p id="tolerance-status" class="tolerance-status-text">-</p>
                        </div>
                         <p id="color-result-note" class="note" style="margin-top:10px;"></p>
                         
                         <div id="delta-breakdown-section" style="margin-top: 15px; display: none;">
                            <h5>Desglose de Diferencias:</h5>
                            <p class="delta-component-text" id="delta-L-value">ΔL*: -</p>
                            <p class="delta-component-text" id="delta-a-value">ΔA*: -</p>
                            <p class="delta-component-text" id="delta-b-value">ΔB*: -</p>
                         </div>
                         <div id="summary-section" style="margin-top: 15px; display: none;">
                            <h5>Resumen para Copiar:</h5>
                            <textarea id="validation-summary" rows="5" style="width: 100%; font-size: 0.8em; padding: 5px; border-radius: var(--border-radius); border: 1px solid var(--border-color);" readonly></textarea>
                            <button id="copy-summary-btn" class="button" style="font-size: 0.8em; padding: 5px 10px; margin-top: 5px;">Copiar Resumen</button>
                         </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            &copy; <span id="currentYearColorValidator"></span> Grupo Azor México. Todos los derechos reservados.
        </footer>
    </div>

    <script type="text/javascript">
        if(document.getElementById('currentYearColorValidator')) {
            document.getElementById('currentYearColorValidator').textContent = new Date().getFullYear();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG SELECCION: Inicio DOMContentLoaded.");
            // ... (otras constantes y variables) ...
            const UMBRAL_EXCELENTE = 2.0;
            const UMBRAL_ACEPTABLE = 5.0;
            const MAX_DELTA_E_FOR_BAR = 10.0;

            const videoElement = document.getElementById('color-video-feed');
            const webcamLoadingPrompt = document.getElementById('webcam-loading-prompt');
            const captureButton = document.getElementById('capture-color-btn');
            const uploadImageInput = document.getElementById('upload-image-btn-input'); 
            
            const displayCanvas = document.getElementById('display-captured-image-canvas');
            const displayCtx = displayCanvas ? displayCanvas.getContext('2d', { willReadFrequently: true }) : null;
            const captureCanvas = document.getElementById('color-capture-canvas'); 
            const captureCtx = captureCanvas ? captureCanvas.getContext('2d', { willReadFrequently: true }) : null;
            
            const capturePrompt = document.getElementById('capture-prompt');
            const instructionTextEl = document.getElementById('instruction-text');
            const compareButton = document.getElementById('compare-colors-btn');
            const standardColorSelect = document.getElementById('standard-color-select');
            
            const capturedColorDisplay = document.getElementById('captured-color-display');
            const capturedColorValuesEl = document.getElementById('captured-color-values');
            const standardColorDisplay = document.getElementById('standard-color-display');
            const standardColorValuesEl = document.getElementById('standard-color-values');
            const deltaEValueEl = document.getElementById('delta-e-value');
            const toleranceBar = document.getElementById('tolerance-bar');
            const toleranceStatusEl = document.getElementById('tolerance-status'); 
            const colorResultNoteEl = document.getElementById('color-result-note');

            const deltaBreakdownSection = document.getElementById('delta-breakdown-section');
            const deltaLValueEl = document.getElementById('delta-L-value');
            const deltaAValueEl = document.getElementById('delta-a-value');
            const deltaBValueEl = document.getElementById('delta-b-value');
            const summarySection = document.getElementById('summary-section');
            const validationSummaryEl = document.getElementById('validation-summary');
            const copySummaryBtn = document.getElementById('copy-summary-btn');

            let stream = null;
            let pickedColorRGB = null; 
            let currentStandardColorData = null;
            let imageIsCaptured = false; 
            let isDrawingSelection = false;
            let selectionRect = { startX: 0, startY: 0, currentX: 0, currentY: 0, width: 0, height: 0 };
            let coloresEstandarCargados = []; // Se llenará con el JSON incrustado

            // Cargar colores desde el JSON incrustado en el HTML
            function cargarColoresDesdeHTML() {
                console.log("DEBUG SELECCION: Entrando a cargarColoresDesdeHTML");
                const jsonDataElement = document.getElementById('coloresEstandarData'); // Asumiendo que tienes el script con este ID
                if (jsonDataElement) {
                    try {
                        coloresEstandarCargados = JSON.parse(jsonDataElement.textContent);
                        if (!Array.isArray(coloresEstandarCargados)) {
                            console.error("Error: El JSON de colores incrustado no es un array.");
                            coloresEstandarCargados = [];
                        }
                        console.log("DEBUG SELECCION: Colores estándar cargados desde JSON incrustado:", coloresEstandarCargados);
                    } catch (error) {
                        console.error("Error al parsear JSON de colores incrustado:", error);
                        coloresEstandarCargados = []; 
                        alert("Error al cargar los datos de colores estándar desde el HTML.");
                    }
                } else {
                    // Si no hay JSON incrustado, usar los colores hardcodeados como fallback (o mostrar error)
                    console.warn("DEBUG SELECCION: No se encontró el elemento script 'coloresEstandarData'. Usando colores hardcodeados como fallback.");
                    // Fallback a los colores originales si el JSON incrustado falla o no existe
                    // (Este objeto es el que proporcionaste en validador_color2.html)
                    const coloresHarcodeados = {
                        "azul_corp": { nombre: "Narana Ferula", hex: "#FA4F00", lab: { L: 59.0, A: 63.9, B: 69.6 } },
                        "rojo_logo": { nombre: "Verde Manzana", hex: "#1D6900", lab: { L: 40.5, A: -40.4, B: 45.3 } },
                        "amarillo_resaltador": { nombre: "Amarillo Resaltador", hex: "#FFEB3B", lab: { L: 93.62, A: -10.16, B: 83.24 } },
                        "verde_producto_eco": { nombre: "Verde Eco Azor", hex: "#4CAF50", lab: { L: 60.32, A: -47.56, B: 46.99 } },
                        "azul_azor_corp_original": { nombre: "Azul Azor Corporativo (Original)", hex: "#007BFF", lab: { L: 53.39, A: 2.71, B: -58.01 } }
                    };
                    // Convertir el objeto hardcodeado a un array similar al formato JSON
                    coloresEstandarCargados = Object.keys(coloresHarcodeados).map(key => ({
                        id: key,
                        nombre: coloresHarcodeados[key].nombre,
                        hex: coloresHarcodeados[key].hex,
                        lab: coloresHarcodeados[key].lab // Asume que ya tiene L, A, B
                    }));
                    console.log("DEBUG SELECCION: Usando colores hardcodeados como fallback:", coloresEstandarCargados);

                }
                populateStandardColors();
            }

            function rgbToHex(r, g, b) {
                const toHex = c => (c < 16 ? '0' : '') + c.toString(16);
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
            }

            function populateStandardColors() {
                if (!standardColorSelect) { return; }
                standardColorSelect.innerHTML = '<option value="">-- Elija un estándar --</option>';
                if (!coloresEstandarCargados || coloresEstandarCargados.length === 0) {
                    standardColorSelect.innerHTML = '<option value="">No hay estándares</option>';
                    return;
                }
                coloresEstandarCargados.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.id; 
                    option.textContent = color.nombre;
                    standardColorSelect.appendChild(option);
                });
            }
            
            async function startWebcam() {
                console.log("DEBUG SELECCION: Iniciando startWebcam...");
                if (!videoElement || !captureCanvas || !displayCanvas || !webcamLoadingPrompt || !capturePrompt || !displayCtx || !captureCtx) {
                    if (webcamLoadingPrompt) webcamLoadingPrompt.textContent = "Error: Elementos de UI no encontrados."; return;
                }
                webcamLoadingPrompt.style.display = 'block'; videoElement.style.display = 'block'; 
                capturePrompt.textContent = "Activando cámara..."; capturePrompt.style.display = 'block'; 
                if (displayCtx) displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } } });
                    videoElement.srcObject = stream;
                    await new Promise((resolve, reject) => { 
                        let resolved = false; let loadAttempts = 0; const maxLoadAttempts = 5; 
                        function checkVideoDimensions() {
                            if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                                if (!resolved) {
                                    captureCanvas.width = videoElement.videoWidth; captureCanvas.height = videoElement.videoHeight;
                                    const webcamContainerEl = document.getElementById('color-webcam-container');
                                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                                    let dCanvasWidth = (webcamContainerEl && webcamContainerEl.clientWidth > 0) ? webcamContainerEl.clientWidth - 2 : 300; 
                                    let dCanvasHeight = dCanvasWidth / aspectRatio;
                                    if (dCanvasHeight > 280) { dCanvasHeight = 280; dCanvasWidth = dCanvasHeight * aspectRatio; }
                                    displayCanvas.width = dCanvasWidth; displayCanvas.height = dCanvasHeight;
                                    resolved = true; resolve();
                                }
                            } else {
                                loadAttempts++;
                                if (loadAttempts < maxLoadAttempts && !resolved) { setTimeout(checkVideoDimensions, 500); } 
                                else if (!resolved) { reject(new Error("Dimensiones del video siguen siendo 0.")); }
                            }
                        }
                        videoElement.onloadedmetadata = checkVideoDimensions; videoElement.oncanplay = checkVideoDimensions; 
                        videoElement.onerror = (e) => { if (!resolved) reject(new Error("Error al cargar metadata/video: " + e)); };
                        setTimeout(() => { if (!resolved) reject(new Error("Timeout esperando metadata/video.")); }, 4000); 
                    });
                    if (webcamLoadingPrompt) webcamLoadingPrompt.style.display = 'none';
                    if (capturePrompt) capturePrompt.textContent = "Cámara activa. Enfoque y capture la imagen.";
                    imageIsCaptured = false; // Se establecerá a true después de una captura o subida exitosa
                    pickedColorRGB = null; 
                    console.log("DEBUG SELECCION: startWebcam completado, imageIsCaptured:", imageIsCaptured);
                    checkEnableCompareButton();
                } catch (err) {
                    console.error("Validador Color: Error al acceder/configurar webcam: ", err);
                    if (webcamLoadingPrompt) webcamLoadingPrompt.textContent = "No se pudo acceder a la cámara. Verifique permisos, o suba una imagen.";
                    if (capturePrompt) capturePrompt.textContent = "Error de cámara. Pruebe subiendo una imagen.";
                }
            }
            
            function resetUIForNewCapture() {
                console.log("DEBUG SELECCION: Entrando a resetUIForNewCapture");
                if (capturePrompt) capturePrompt.style.display = 'none'; 
                imageIsCaptured = true; // ¡CRUCIAL PARA PERMITIR DIBUJO!
                console.log("DEBUG SELECCION: resetUIForNewCapture - imageIsCaptured puesto a:", imageIsCaptured);
                pickedColorRGB = null; 
                if (compareButton) {
                    compareButton.disabled = true;
                    compareButton.innerHTML = '<i class="fas fa-exchange-alt"></i> Comparar Colores';
                }
                if(capturedColorDisplay) capturedColorDisplay.style.backgroundColor = 'transparent';
                if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Dibuje un área en la imagen';
                if(deltaEValueEl) deltaEValueEl.textContent = '-';
                if(toleranceStatusEl) { toleranceStatusEl.textContent = '-'; toleranceStatusEl.className = 'tolerance-status-text'; }
                if(toleranceBar) { toleranceBar.style.width = '0%'; toleranceBar.className = 'tolerance-bar-fill'; }
                if(instructionTextEl) instructionTextEl.textContent = "Dibuje un recuadro en la imagen para seleccionar el área de color.";
                if(colorResultNoteEl) colorResultNoteEl.textContent = '';
                if (deltaBreakdownSection) deltaBreakdownSection.style.display = 'none';
                if (summarySection) summarySection.style.display = 'none';
                if (validationSummaryEl) validationSummaryEl.value = '';
                checkEnableCompareButton();
            }

            function processImageAndDisplay(sourceElementOrCanvas, isUploadedImage = false) {
                console.log("DEBUG SELECCION: Entrando a processImageAndDisplay, isUploadedImage:", isUploadedImage);
                 if (isUploadedImage) { 
                    captureCanvas.width = sourceElementOrCanvas.naturalWidth; captureCanvas.height = sourceElementOrCanvas.naturalHeight;
                    captureCtx.drawImage(sourceElementOrCanvas, 0, 0, captureCanvas.width, captureCanvas.height);
                } else { 
                    if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                        captureCanvas.width = videoElement.videoWidth; captureCanvas.height = videoElement.videoHeight;
                    } else {
                        console.warn("Dimensiones del video no disponibles, usando fallback.");
                        captureCanvas.width = 640; captureCanvas.height = 480; 
                    }
                    captureCtx.drawImage(videoElement, 0, 0, captureCanvas.width, captureCanvas.height);
                }
                const aspectRatio = captureCanvas.width / captureCanvas.height;
                let dCanvasWidth = displayCanvas.parentElement.clientWidth > 0 ? displayCanvas.parentElement.clientWidth - 2 : 300;
                let dCanvasHeight = dCanvasWidth / aspectRatio;
                if (dCanvasHeight > 280) { dCanvasHeight = 280; dCanvasWidth = dCanvasHeight * aspectRatio; }
                displayCanvas.width = dCanvasWidth; displayCanvas.height = dCanvasHeight;
                if (displayCtx) {
                    displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height); 
                    displayCtx.drawImage(captureCanvas, 0, 0, displayCanvas.width, displayCanvas.height);
                }
                resetUIForNewCapture(); // ESTO ES CLAVE: establece imageIsCaptured = true
                console.log("DEBUG SELECCION: processImageAndDisplay completado, imageIsCaptured debería ser true. Valor actual:", imageIsCaptured);
            }

            if (captureButton) { 
                captureButton.addEventListener('click', () => {
                    console.log("DEBUG SELECCION: Botón 'Capturar Imagen' clickeado.");
                    if (!stream || !videoElement.srcObject || videoElement.paused || videoElement.ended) {
                         if (capturePrompt) capturePrompt.textContent = "La cámara no está activa."; return;
                    }
                    processImageAndDisplay(videoElement, false);
                });
            }

            if (uploadImageInput) { 
                 uploadImageInput.addEventListener('change', (event) => {
                    console.log("DEBUG SELECCION: Evento 'change' en input de subida.");
                    const file = event.target.files[0];
                    if (file) {
                        console.log("DEBUG SELECCION: Archivo seleccionado:", file.name);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                console.log("DEBUG SELECCION: Imagen cargada desde archivo.");
                                if (stream) {
                                    stream.getTracks().forEach(track => track.stop()); stream = null;
                                    videoElement.srcObject = null; videoElement.style.display = 'none'; 
                                    if (webcamLoadingPrompt) webcamLoadingPrompt.style.display = 'none';
                                }
                                if (capturePrompt) capturePrompt.textContent = "Imagen cargada. Seleccione el área.";
                                processImageAndDisplay(img, true);
                            }
                            img.onerror = () => { console.error("Error al cargar la imagen del archivo."); }
                            img.src = e.target.result;
                        }
                        reader.onerror = () => { console.error("Error al leer el archivo."); }
                        reader.readAsDataURL(file);
                    }
                    event.target.value = null;
                });
            }

            function checkEnableCompareButton() {
                if (compareButton) {
                    const standardSelected = standardColorSelect && standardColorSelect.value !== "" && currentStandardColorData;
                    compareButton.disabled = !(pickedColorRGB && standardSelected);
                }
            }

            if (displayCanvas && displayCtx && captureCtx) {
                console.log("DEBUG SELECCION: Añadiendo event listeners a displayCanvas.");
                displayCanvas.addEventListener('mousedown', (event) => {
                    console.log("DEBUG SELECCION: Mousedown en displayCanvas. imageIsCaptured:", imageIsCaptured);
                    if (!imageIsCaptured) {
                        console.log("DEBUG SELECCION: Mousedown ignorado, imageIsCaptured es false.");
                        return; 
                    }
                    isDrawingSelection = true; 
                    console.log("DEBUG SELECCION: Mousedown - isDrawingSelection puesto a true.");
                    const rect = displayCanvas.getBoundingClientRect();
                    selectionRect.startX = event.clientX - rect.left; selectionRect.startY = event.clientY - rect.top;
                    selectionRect.currentX = selectionRect.startX; selectionRect.currentY = selectionRect.startY;
                    selectionRect.width = 0; selectionRect.height = 0;
                    pickedColorRGB = null; 
                    if(capturedColorDisplay) capturedColorDisplay.style.backgroundColor = 'transparent';
                    if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Dibujando área...';
                    checkEnableCompareButton(); 
                });

                displayCanvas.addEventListener('mousemove', (event) => {
                    if (!imageIsCaptured || !isDrawingSelection) return;
                    const rect = displayCanvas.getBoundingClientRect();
                    selectionRect.currentX = event.clientX - rect.left; selectionRect.currentY = event.clientY - rect.top;
                    selectionRect.width = selectionRect.currentX - selectionRect.startX;
                    selectionRect.height = selectionRect.currentY - selectionRect.startY;
                    if (captureCanvas && captureCanvas.width > 0 && captureCanvas.height > 0 && displayCtx) { 
                        displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
                        displayCtx.drawImage(captureCanvas, 0, 0, displayCanvas.width, displayCanvas.height);
                        displayCtx.strokeStyle = 'rgba(0, 123, 255, 0.8)'; displayCtx.lineWidth = 2;
                        displayCtx.strokeRect(selectionRect.startX, selectionRect.startY, selectionRect.width, selectionRect.height);
                    }
                });

                displayCanvas.addEventListener('mouseup', () => { 
                    console.log("DEBUG SELECCION: Mouseup en displayCanvas. isDrawingSelection:", isDrawingSelection, "imageIsCaptured:", imageIsCaptured);
                    if (!imageIsCaptured || !isDrawingSelection) { 
                        isDrawingSelection = false; 
                        console.log("DEBUG SELECCION: Mouseup - Saliendo temprano, isDrawingSelection o imageIsCaptured es false.");
                        return; 
                    }
                    isDrawingSelection = false;
                    console.log("DEBUG SELECCION: Mouseup - isDrawingSelection puesto a false.");
                    let finalRectX = Math.min(selectionRect.startX, selectionRect.currentX);
                    let finalRectY = Math.min(selectionRect.startY, selectionRect.currentY);
                    let finalRectWidth = Math.abs(selectionRect.width);
                    let finalRectHeight = Math.abs(selectionRect.height);
                    if (!(displayCtx && captureCanvas && captureCanvas.width > 0 && captureCanvas.height > 0 && captureCtx)) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Imagen base no disp.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
                    displayCtx.drawImage(captureCanvas, 0, 0, displayCanvas.width, displayCanvas.height);
                    if (finalRectWidth < 1 || finalRectHeight < 1) { 
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Área muy pequeña.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    if (displayCanvas.width === 0 || displayCanvas.height === 0) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Display inválido.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    const scaleX = captureCanvas.width / displayCanvas.width; const scaleY = captureCanvas.height / displayCanvas.height;
                    let originalX = Math.floor(finalRectX * scaleX); let originalY = Math.floor(finalRectY * scaleY);
                    let originalWidth = Math.floor(finalRectWidth * scaleX); let originalHeight = Math.floor(finalRectHeight * scaleY);
                    originalX = Math.max(0, Math.min(originalX, captureCanvas.width - 1));
                    originalY = Math.max(0, Math.min(originalY, captureCanvas.height - 1));
                    originalWidth = Math.max(1, Math.min(originalWidth, captureCanvas.width - originalX)); 
                    originalHeight = Math.max(1, Math.min(originalHeight, captureCanvas.height - originalY));
                    if (originalWidth <= 0 || originalHeight <= 0) {
                        if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error: Área cálculo inválida.';
                        pickedColorRGB = null; checkEnableCompareButton(); return;
                    }
                    try {
                        const imageData = captureCtx.getImageData(originalX, originalY, originalWidth, originalHeight);
                        const data = imageData.data; let sumR = 0, sumG = 0, sumB = 0; let pixelCount = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            sumR += data[i]; sumG += data[i+1]; sumB += data[i+2]; pixelCount++;
                        }
                        if (pixelCount > 0) {
                            pickedColorRGB = { r: Math.round(sumR / pixelCount), g: Math.round(sumG / pixelCount), b: Math.round(sumB / pixelCount) };
                            const hexPicked = rgbToHex(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b);
                            let labCapturedText = 'N/A'; let labConversionOk = false;
                            if (typeof window.chroma !== 'undefined') { 
                                try {
                                    const labArr = window.chroma(pickedColorRGB.r, pickedColorRGB.g, pickedColorRGB.b).lab();
                                    labCapturedText = `${labArr[0].toFixed(1)}, ${labArr[1].toFixed(1)}, ${labArr[2].toFixed(1)}`;
                                    labConversionOk = true;
                                } catch (chromaError) { console.error("Error al usar chroma-js:", chromaError); if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: Error chroma.js`; }
                            } else { console.warn("Librería 'chroma-js' NO definida."); if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: Error lib. conversión`; }
                            if (capturedColorDisplay) capturedColorDisplay.style.backgroundColor = hexPicked;
                            if (labConversionOk) { if(capturedColorValuesEl) capturedColorValuesEl.textContent = `HEX: ${hexPicked} | LAB: ${labCapturedText}`; }
                            if (instructionTextEl) instructionTextEl.textContent = "Área seleccionada. Elija un estándar.";
                            displayCtx.strokeStyle = 'rgba(40, 167, 69, 0.9)'; displayCtx.lineWidth = 2;
                            displayCtx.strokeRect(finalRectX, finalRectY, finalRectWidth, finalRectHeight); 
                        } else { if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'No se pudo promediar (0px).'; pickedColorRGB = null; }
                    } catch (e) { console.error("Error procesando área (catch):", e); if(capturedColorValuesEl) capturedColorValuesEl.textContent = 'Error procesar área.'; pickedColorRGB = null; }
                    checkEnableCompareButton();
                 });
            } else {
                console.error("DEBUG SELECCION: displayCanvas, displayCtx, o captureCtx NO están disponibles.");
            }
            
            if (standardColorSelect) {
                standardColorSelect.addEventListener('change', () => { /* ... (sin cambios) ... */ });
            }

            if (compareButton) {
                compareButton.addEventListener('click', () => { /* ... (sin cambios, la lógica que ya funcionaba) ... */ });
            }
            
            if (copySummaryBtn) { /* ... (sin cambios) ... */  }
            
            async function inicializarValidador() {
                console.log("DEBUG SELECCION: Entrando a inicializarValidador.");
                cargarColoresDesdeHTML(); 
                await startWebcam(); 
                console.log("DEBUG SELECCION: inicializarValidador completado.");
            }
            inicializarValidador();
        });
    </script>
</body>
</html>